# auto merge
# This is a generated workflow and can be _overwritten_ without notice
name: auto-merge

env:
WF: '{"branches": ["prod"], "id": "auto-merge", "merge_to_branches": ["dev", "qa"], "trigger_run_on_branches": ["prod"], "wf": "amerge", "working_dir": "."}'
REPOID: dhfdw
ENVR:

on:
workflow_dispatch:
push:
branches:
- prod

jobs:
auto-merge:
permissions: write-all
runs-on: ubuntu-latest

defaults:
run:
working-directory: ${{ fromJSON(env.WF)['working_dir'] }}
steps:
- name: Checkout
uses: actions/checkout@v4
with:
fetch-depth: 0
token: ${{ secrets.GHUB_TOKEN }}

- name: Init
shell: bash
run : |
echo Actor: ${{ github.actor }}
echo "DRY_RUN=no" >> $GITHUB_ENV
# [[ "${{ github.event.inputs.dry-run }}" == "true" ]] && { echo "DRY_RUN=yes" >> $GITHUB_ENV; } || { echo "DRY_RUN=no" >> $GITHUB_ENV; }
git config --global url."https://${{ secrets.GHUB_TOKEN }}@github.com".insteadOf https://github.com
git config --global --add safe.directory /__w/${GITHUB_REPOSITORY#*/}/${GITHUB_REPOSITORY#*/}
wget --header='Authorization: token ${{ secrets.GHUB_TOKEN }}' \
https://raw.githubusercontent.com/McK-Internal/CDP-DevOps/main/tf/devops/ghub/wflows/scripts/wflow.py

- name: Check
shell: bash
env:
REPO: ${{ github.repository }}
WFLOW: ${{ github.workflow }}
SHA: ${{ github.sha }}
REF: ${{ github.ref }}
WF: ${{ env.WF }}
REF_NAME: ${{ github.ref_name }}
GHUB_TOKEN: ${{ secrets.GHUB_TOKEN }}
run: |
python3 wflow.py check

- name: Auto merge
shell: bash
env:
BRANCHES: ${{ toJSON(fromJSON(env.WF)['branches']) }}
MERGETO_BRANCHES: ${{ toJSON(fromJSON(env.WF)['merge_to_branches']) }}
run: |
wget --header='Authorization: token ${{ secrets.GHUB_TOKEN }}' \
https://raw.githubusercontent.com/McK-Internal/CDP-DevOps/main/tf/devops/ghub/wflows/scripts/amerge.py
python3 amerge.py

- name: End
env:
REPO: ${{ github.repository }}
WFLOW: ${{ github.workflow }}
SHA: ${{ github.sha }}
run: |
python3 wflow.py end
